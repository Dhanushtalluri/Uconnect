<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Uconnect Mermaid AI Diagram Tool</title>
  <!-- Mermaid.js: Draws diagrams from text descriptions -->
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10.8.0/dist/mermaid.min.js"></script>
  <!-- html2canvas and jsPDF: Save diagrams as PNG or PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    /* Blue and white theme with clean modern look */
    body {
      margin: 0;
      background: #f0f4ff;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: #0a2e8a;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-bottom: 40px;
    }
    header {
      width: 100%;
      background: #0033cc;
      color: white;
      display: flex;
      align-items: center;
      padding: 12px 24px;
      box-shadow: 0 2px 6px rgb(0 51 204 / 0.4);
      margin-bottom: 20px;
    }
    header .logo {
      width: 36px;
      height: 36px;
      background-color: white;
      border-radius: 6px;
      margin-right: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: #0033cc;
      font-size: 1.2em;
      user-select: none;
    }
    header h1 {
      font-size: 1.6em;
      font-weight: 700;
      margin: 0;
      user-select: none;
    }
    #container {
      max-width: 760px;
      width: 100%;
      background: white;
      box-shadow: 0 4px 20px rgb(0 0 60 / 0.12);
      border-radius: 12px;
      padding: 30px 32px 32px 32px;
      box-sizing: border-box;
      position: relative;
    }
    h2 {
      margin-top: 0;
      margin-bottom: 14px;
      color: #002080;
      font-weight: 700;
      user-select: none;
      text-align: center;
      font-size: 1.8em;
    }
    label {
      font-weight: 600;
      display: block;
      margin-bottom: 6px;
      color: #0047d4;
      user-select: none;
    }
    textarea {
      width: 100%;
      font-size: 1em;
      border-radius: 8px;
      border: 1.5px solid #84a0ff;
      padding: 10px 14px;
      font-family: 'Consolas', monospace, monospace;
      box-sizing: border-box;
      resize: vertical;
      transition: border-color 0.25s ease-in-out;
      color: #001044;
      background: #f9fbff;
      min-height: 120px;
    }
    textarea:focus {
      outline: none;
      border-color: #0033cc;
      background: #ffffff;
      box-shadow: 0 0 8px rgb(0 51 204 / 0.4);
    }
    button {
      background: #0033cc;
      border: none;
      color: white;
      font-weight: 700;
      font-size: 1em;
      padding: 10px 22px;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      user-select: none;
      margin-top: 12px;
      width: 100%;
      box-sizing: border-box;
    }
    button:hover:not(:disabled) {
      background: #001a99;
    }
    button:disabled {
      background: #7a91e6;
      cursor: default;
    }
    #diagram {
      background: #eef2ff;
      min-height: 180px;
      border-radius: 8px;
      margin: 24px 0 14px 0;
      padding: 16px 12px;
      box-sizing: border-box;
      overflow-x: auto;
      font-family: monospace;
      color: #283593;
      position: relative;
      min-height: 300px;
    }
    #error {
      color: #cc2020;
      font-weight: 700;
      margin-bottom: 12px;
      display: none;
      text-align: center;
    }
    #export-btns {
      margin-top: 12px;
      display: flex;
      gap: 12px;
      justify-content: center;
    }
    #export-btns button {
      width: auto;
      flex: 1 1 auto;
    }
    /* Watermark: fixed in diagram bottom-right corner */
    #watermark {
      position: absolute;
      bottom: 8px;
      right: 8px;
      font-size: 12px;
      color: rgba(0, 51, 204, 0.4);
      font-weight: 700;
      user-select: none;
      pointer-events: none;
      z-index: 10;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
  </style>
</head>
<body>
  <header>
    <div class="logo" aria-label="Uconnect logo">U</div>
    <h1>Uconnect</h1>
  </header>
  <div id="container" role="main" aria-label="Mermaid AI Diagram Tool container">
    <h2>Mermaid AI Diagram Tool (for Students)</h2>
    <div class="example" aria-live="polite" aria-atomic="true">
      <strong>Example Prompt:</strong><br />
      <i>“Create a hierarchical chart showing Python Data Types”</i>
    </div>

    <label for="inputText">Describe your diagram:</label>
    <textarea id="inputText" placeholder="Type your diagram description here." aria-describedby="examplePrompt"></textarea>

    <button id="generateBtn">Generate Diagram</button>

    <div id="error" role="alert" aria-live="assertive"></div>

    <div id="diagram" role="region" aria-live="polite" aria-atomic="true">
      <div id="watermark">Powered by UCONNECT</div>
    </div>

    <div id="export-btns" style="display:none;">
      <button id="exportPNGBtn">Export as PNG</button>
      <button id="exportPDFBtn">Export as PDF</button>
    </div>
  </div>

  <script>
    // ====== REQUIRED: Replace with your actual OpenRouter API key ======
const OPENROUTER_API_KEY = "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";

    // Fixed values
    const fixedModel = "openai/gpt-3.5-turbo";
    const fixedDiagramType = "flowchart";
    const mermaidStartToken = "graph TD";

    // DOM elements
    const inputText = document.getElementById("inputText");
    const generateBtn = document.getElementById("generateBtn");
    const errorDiv = document.getElementById("error");
    const diagramDiv = document.getElementById("diagram");
    const exportBtns = document.getElementById("export-btns");
    const exportPNGBtn = document.getElementById("exportPNGBtn");
    const exportPDFBtn = document.getElementById("exportPDFBtn");
    const watermark = document.getElementById("watermark");

    let latestMermaidCode = ""; // To store AI-generated Mermaid code

    generateBtn.addEventListener("click", generateDiagram);
    exportPNGBtn.addEventListener("click", exportPNG);
    exportPDFBtn.addEventListener("click", exportPDF);

    async function generateDiagram() {
      errorDiv.style.display = "none";
      errorDiv.textContent = "";
      diagramDiv.innerHTML = '<div id="watermark">Powered by UCONNECT</div>';
      exportBtns.style.display = "none";

      const prompt = inputText.value.trim();
      if (!OPENROUTER_API_KEY || OPENROUTER_API_KEY.includes("YOUR_OPENROUTER_API_KEY")) {
        errorDiv.textContent = "Please enter your OpenRouter API key in the code before using this tool.";
        errorDiv.style.display = "block";
        return;
      }
      if (!prompt) {
        errorDiv.textContent = "Please describe your diagram in the box above.";
        errorDiv.style.display = "block";
        return;
      }

      const aiPrompt =
        `Convert the following text to Mermaid code for a flowchart (graph TD). Only output valid Mermaid code. Do not include any Markdown or comments.\nText: ${prompt}`;

      generateBtn.disabled = true;
      generateBtn.textContent = "Generating...";

      try {
        const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
          method: "POST",
          headers: {
            Authorization: `Bearer ${OPENROUTER_API_KEY}`,
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            model: fixedModel,
            messages: [
              { role: "system", content: "You generate diagrams in Mermaid format only, never markdown. Never include explanations or code fences." },
              { role: "user", content: aiPrompt },
            ],
            max_tokens: 600,
          }),
        });

        if (!response.ok) throw new Error("API request failed: " + response.status);
        const data = await response.json();

        let mermaidCode = data.choices?.[0]?.message?.content || "";
        mermaidCode = cleanMermaidCode(mermaidCode, mermaidStartToken);

        if (!mermaidCode.toLowerCase().startsWith(mermaidStartToken.toLowerCase())) {
          throw new Error("The AI did not return valid Mermaid code. Try rephrasing your prompt.");
        }

        latestMermaidCode = mermaidCode;
        renderMermaid(mermaidCode);
        exportBtns.style.display = "flex";
      } catch (error) {
        errorDiv.textContent = "Error: " + error.message;
        errorDiv.style.display = "block";
      } finally {
        generateBtn.disabled = false;
        generateBtn.textContent = "Generate Diagram";
      }
    }

    function cleanMermaidCode(code, startToken) {
      code = code.replace(/```/g, "");
      const idx = code.toLowerCase().indexOf(startToken.toLowerCase());
      return idx >= 0 ? code.slice(idx) : code;
    }

    function renderMermaid(mermaidCode) {
      mermaid.initialize({
        startOnLoad: false,
        theme: "default",
        fontFamily: "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif",
        flowchart: { curve: "basis" },
      });
      diagramDiv.innerHTML = `<div class="mermaid" id="mermaid-svg">${mermaidCode}</div>`;
      // Re-add watermark after replacing innerHTML
      diagramDiv.appendChild(watermark);
      mermaid.init(undefined, "#mermaid-svg");
    }

    function exportPNG() {
      // Temporarily show watermark if hidden
      watermark.style.display = "block";

      html2canvas(diagramDiv).then((canvas) => {
        const link = document.createElement("a");
        link.download = "diagram.png";
        link.href = canvas.toDataURL("image/png");
        link.click();
        // Optional: hide watermark after export if needed
      });
    }

    function exportPDF() {
      // Temporarily show watermark if hidden
      watermark.style.display = "block";

      html2canvas(diagramDiv).then((canvas) => {
        const imgData = canvas.toDataURL("image/png");
        const pdf = new window.jspdf.jsPDF({
          orientation: "landscape",
          unit: "px",
          format: [canvas.width, canvas.height],
        });
        pdf.addImage(imgData, "PNG", 0, 0, canvas.width, canvas.height);
        pdf.save("diagram.pdf");
        // Optional: hide watermark after export if needed
      });
    }
  </script>
</body>
</html>
